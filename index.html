<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POD Order Processing Tool</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Required libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
</head>
<body class="bg-light">
    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-12">
                <div class="card shadow">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">POD Order Processing Tool</h4>
                        <div>
                            <button class="btn btn-outline-light me-2" onclick="clearAll()" id="clearBtn" disabled>
                                Clear All
                            </button>
                            <button class="btn btn-outline-light" onclick="downloadCsv()" id="downloadBtn" disabled>
                                Download CSV
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="orderRef" class="form-label">Order Reference</label>
                                    <input type="text" class="form-control" id="orderRef" placeholder="Enter order reference">
                                    <div class="order-ref-warning" id="orderRefWarning">Please enter an order reference</div>
                                </div>
                                <div class="mb-3">
                                    <label for="emailAddress" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="emailAddress" placeholder="Enter email address">
                                </div>
                                <div class="mb-3">
                                    <label for="emailSubject" class="form-label">Email Subject</label>
                                    <input type="text" class="form-control" id="emailSubject" placeholder="Enter email subject">
                                </div>
                                <div class="mb-3">
                                    <div class="d-grid gap-2">
                                        <button type="button" class="btn btn-primary" onclick="sendEmail()" id="emailBtn" disabled>
                                            <i class="fas fa-envelope"></i> Send Email
                                        </button>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="excelFile" class="form-label">Upload Excel File (ISBN and Quantity columns)</label>
                                    <input type="file" class="form-control" id="excelFile" accept=".xlsx,.xls">
                                </div>
                                <div class="mb-3">
                                    <button type="button" class="btn btn-secondary" onclick="downloadTemplate()">
                                        <i class="fas fa-download"></i> Download Template
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info mt-md-4" id="status" style="display: none;"></div>
                            </div>
                        </div>

                        <!-- Preview Table -->
                        <div class="mb-3">
                            <button class="btn btn-danger" onclick="deleteSelected()" id="deleteSelectedBtn" disabled>
                                <i class="fas fa-trash"></i> Delete Selected Rows
                            </button>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-bordered table-hover" id="previewTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>
                                            <input type="checkbox" id="selectAll" onclick="toggleAllCheckboxes()">
                                        </th>
                                        <th>Action</th>
                                        <th>Order Ref</th>
                                        <th>ISBN</th>
                                        <th>Description</th>
                                        <th>Quantity</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="previewBody">
                                    <tr>
                                        <td colspan="5" class="text-center">No data loaded</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let booksData = [];
        let processedOrders = [];

        // Fetch ISBN data when page loads
        async function fetchData() {
            try {
                const response = await fetch('data.json');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                booksData = await response.json();
            } catch (error) {
                console.error('Error fetching data:', error);
                showStatus('Error loading book data: ' + error.message, 'danger');
            }
        }

        // Enable file input handling
        document.getElementById('excelFile').addEventListener('change', handleFileSelect);

        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;

            // Check for order reference
            const orderRef = document.getElementById('orderRef').value.trim();
            const orderRefWarning = document.getElementById('orderRefWarning');
            
            if (!orderRef) {
                orderRefWarning.style.display = 'block';
                showStatus('Please enter an order reference before uploading a file', 'warning');
                document.getElementById('excelFile').value = ''; // Clear the file input
                return;
            }
            
            orderRefWarning.style.display = 'none';

            try {
                showStatus('Processing file...', 'info');
                
                // Read Excel file
                const arrayBuffer = await file.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { 
                    type: 'array',
                    cellText: false,
                    cellDates: true
                });
                const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                
                const excelData = XLSX.utils.sheet_to_json(worksheet, {
                    header: 1,
                    raw: false,
                    defval: ''
                });

                // Remove header row if present
                if (excelData.length > 0 && typeof excelData[0][0] === 'string') {
                    excelData.shift();
                }

                // Create a Map for faster lookups
                const booksMap = new Map(booksData.map(item => [item.code, item]));

                // Process each row
                processedOrders = excelData.map((row) => {
                    let isbn = String(row[0] || '');
                    if (isbn.includes('e')) {
                        isbn = Number(isbn).toFixed(0);
                    }
                    isbn = isbn.replace(/\D/g, '').padStart(13, '0');
                    const quantity = parseInt(row[1]) || 0;
                    
                    const stockItem = booksMap.get(isbn);
                    
                    return {
                        isbn,
                        description: stockItem?.description || 'Not Found',
                        quantity,
                        available: !!stockItem,
                        setupDate: stockItem?.setupdate || ''
                    };
                });

                updatePreviewTable();
                showStatus('Data loaded successfully!', 'success');
                enableButtons(true);
            } catch (error) {
                console.error('Processing error:', error);
                showStatus('Error processing file. Please check the format and try again.', 'danger');
                enableButtons(false);
            }
        }

        function updatePreviewTable() {
            const tbody = document.getElementById('previewBody');
            tbody.innerHTML = '';

            if (processedOrders.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center">No data loaded</td></tr>';
                return;
            }

            processedOrders.forEach((order, index) => {
                const tr = document.createElement('tr');
                const orderRef = document.getElementById('orderRef').value || '';
                tr.innerHTML = `
                    <td>
                        <input type="checkbox" class="row-checkbox" data-index="${index}">
                    </td>
                    <td>
                        <button class="btn btn-danger btn-sm" onclick="deleteRow(${index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                    <td>${orderRef}</td>
                    <td>${order.isbn}</td>
                    <td>${order.description}</td>
                    <td>${order.quantity}</td>
                    <td>
                        <span class="badge ${order.available ? 'bg-success' : 'bg-danger'}">
                            ${order.available ? 'Available' : 'Not Found'}
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function deleteRow(index) {
            processedOrders.splice(index, 1);
            updatePreviewTable();
            showStatus(`Row ${index + 1} deleted`, 'info');
            enableButtons(processedOrders.length > 0);
        }

        function clearAll() {
            processedOrders = [];
            updatePreviewTable();
            document.getElementById('excelFile').value = '';
            document.getElementById('orderRef').value = '';  // Clear order reference
            showStatus('All data cleared', 'info');
            enableButtons(false);
        }

        function downloadCsv() {
            if (processedOrders.length === 0) {
                showStatus('No data to download', 'warning');
                return;
            }

            try {
                // Convert to CSV - format to be specified
                const csv = Papa.unparse(processedOrders);

                // Create and trigger download
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const now = new Date();
                const filename = `pod_order_${now.getFullYear()}_${
                    String(now.getMonth() + 1).padStart(2, '0')}_${
                    String(now.getDate()).padStart(2, '0')}_${
                    String(now.getHours()).padStart(2, '0')}_${
                    String(now.getMinutes()).padStart(2, '0')}_${
                    String(now.getSeconds()).padStart(2, '0')}.csv`;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                showStatus('CSV downloaded successfully!', 'success');
            } catch (error) {
                console.error('Download error:', error);
                showStatus('Error creating CSV file', 'danger');
            }
        }

        function enableButtons(enabled) {
            document.getElementById('clearBtn').disabled = !enabled;
            document.getElementById('downloadBtn').disabled = !enabled;
            document.getElementById('emailBtn').disabled = !enabled;
            document.getElementById('deleteSelectedBtn').disabled = !enabled;
            document.getElementById('selectAll').checked = false;
        }

        function toggleAllCheckboxes() {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            const selectAllCheckbox = document.getElementById('selectAll');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
        }

        function deleteSelected() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const indices = Array.from(checkboxes)
                .map(checkbox => parseInt(checkbox.dataset.index))
                .sort((a, b) => b - a); // Sort in descending order

            indices.forEach(index => {
                processedOrders.splice(index, 1);
            });

            updatePreviewTable();
            showStatus(`${indices.length} rows deleted`, 'info');
            enableButtons(processedOrders.length > 0);
        }

        async function downloadTemplate() {
            try {
                const response = await fetch('order_template.xlsx');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'order_template.xlsx';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Error downloading template:', error);
                showStatus('Error downloading template', 'danger');
            }
        }

        function sendEmail() {
            const email = document.getElementById('emailAddress').value;
            const subject = document.getElementById('emailSubject').value;

            if (!email) {
                showStatus('Please enter an email address', 'warning');
                return;
            }

            if (!subject) {
                showStatus('Please enter an email subject', 'warning');
                return;
            }

            // Create email content
            const content = processedOrders.map(order => 
                `ISBN: ${order.isbn}\nDescription: ${order.description}\nQuantity: ${order.quantity}\nStatus: ${order.available ? 'Available' : 'Not Found'}`
            ).join('\n\n');

            // Create mailto link
            const mailtoLink = `mailto:${email}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(content)}`;
            window.location.href = mailtoLink;
        }

        function showStatus(message, type) {
            const statusDiv = document.getElementById('status');
            statusDiv.className = `alert alert-${type}`;
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Hide status after 3 seconds for success messages and info messages
            if (type === 'success' || type === 'info') {
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            }
        }

        // Initialize by fetching data
        fetchData();
    </script>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>